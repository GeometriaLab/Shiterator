(function(){function l(a){return a<10?"0"+a:a}function p(a){q.lastIndex=0;return q.test(a)?'"'+a.replace(q,function(a){var c=r[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function n(a,b){var c,e,g,i,h=j,d,f=b[a];f&&typeof f==="object"&&typeof f.toJSON==="function"&&(f=f.toJSON(a));typeof k==="function"&&(f=k.call(b,a,f));switch(typeof f){case "string":return p(f);case "number":return isFinite(f)?String(f):"null";case "boolean":case "null":return String(f);
case "object":if(!f)return"null";j+=o;d=[];if(Object.prototype.toString.apply(f)==="[object Array]"){i=f.length;for(c=0;c<i;c+=1)d[c]=n(c,f)||"null";g=d.length===0?"[]":j?"[\n"+j+d.join(",\n"+j)+"\n"+h+"]":"["+d.join(",")+"]";j=h;return g}if(k&&typeof k==="object"){i=k.length;for(c=0;c<i;c+=1)typeof k[c]==="string"&&(e=k[c],(g=n(e,f))&&d.push(p(e)+(j?": ":":")+g))}else for(e in f)Object.prototype.hasOwnProperty.call(f,e)&&(g=n(e,f))&&d.push(p(e)+(j?": ":":")+g);g=d.length===0?"{}":j?"{\n"+j+d.join(",\n"+
j)+"\n"+h+"}":"{"+d.join(",")+"}";j=h;return g}}function s(a,b,c){if(JSON&&JSON.stringify)return JSON.stringify(a,b,c);var e;o=j="";if(typeof c==="number")for(e=0;e<c;e+=1)o+=" ";else typeof c==="string"&&(o=c);if((k=b)&&typeof b!=="function"&&(typeof b!=="object"||typeof b.length!=="number"))throw Error("JSON.stringify");return n("",{"":a})}function t(){}function u(a){var b=a.length,c=0;b%4&&(a+="0000000".substr(0,4-b%4));var e=0;for(b/=4;e<b;++e)for(var g=0;g<4;++g)c+=a.charCodeAt(e*4+g)<<g*8;return Math.abs(c)%
4294967295}Shiterator=function(a,b){this.__callback=a||t;var c={host:null,port:6666,postingPeriod:1,forgetErrorsAfter:0,errorsLimit:10},e;for(e in b)b.hasOwnProperty(e)&&(c[e]=b[e]);this._options=c;this.__ShiteratorInit()};Shiterator.prototype.__ShiteratorInit=function(){this.__started=!1;this.__errorsToPost=[];this.__knownErrors=new d(this._options.forgetErrorsAfter||365);this.__errorsCount=0;this.__postErrorTimeout=null;this.__url=this.__getFullUrl();this.__form=null;new m(this.__errorHandler,this)};
Shiterator.prototype.__getFullUrl=function(){if(this._options.host)return(this._options.host.indexOf("http://")!==0?"http://":"")+this._options.host+(this._options.port?":"+this._options.port:"");return null};Shiterator.prototype.__convertErrorToData=function(a,b,c){return{type:"javascript",subject:a+" on "+b+":"+c,message:a,line:c,stack:"not available",tracker:{},file:b,custom:{url:document.location.href,referer:document.referrer}}};Shiterator.prototype.__errorHandler=function(a,b,c){if(this.__started&&
!(this.__errorsCount>=this._options.errorsLimit)){var e=u(a+" on "+b+":"+c,4),g=this,a=this.__convertErrorToData(a,b,c);if(!this.__knownErrors.has(e)&&(this.__callback.call(window,a),this.__knownErrors.put(e),this.__errorsToPost.push(a),this.__errorsCount++,!this.__postErrorTimeout))this.__postErrorTimeout=setTimeout(function(){g.__submitErrors()},this._options.postingPeriod*1E3)}};Shiterator.prototype.__submitErrors=function(){if(this.__url){if(!this.__form){var a=document.createElement("div");a.style.display=
"none";a.innerHTML='<form action="'+this.__url+'" method="post" target="shiterator-error-frame" name="shiterator-form"><input type=\'hidden\' name=\'errors\' value=\'\'></form><iframe id="shiterator-error-frame" name="shiterator-error-frame"></iframe>';document.body.appendChild(a);this.__form=a.getElementsByTagName("form")[0]}var b=a.getElementsByTagName("iframe")[0],a=a.getElementsByTagName("input")[0],c=s(this.__errorsToPost);a.setAttribute("value",c);b.onload=function(){b.onload=null;self.stop()};
this.__form.submit()}};Shiterator.prototype.start=function(){this.__started=!0};Shiterator.prototype.stop=function(){if(this.__started)this.__errorsCount=this.__errorsToPost.length=0,this.__started=!1,clearTimeout(this.__postErrorTimeout)};var d=function(a){if(this.constructor._Singleton)return this;else this.constructor._Singleton=this;this.__retrieveFromCookies(a)};d.prototype.__retrieveFromCookies=function(a){this.__storage=[];var b=this.__getCookie("shiterator");if(b)this.__storage=b.split("/");
(b=this.__storage.shift())||(b=new Date((new Date).getTime()+a*864E5));this.__expires=this.__expires=b};d.prototype.__setCookie=function(a,b,c,e,g,d){var h=new Date;h.setTime(h.getTime());h=new Date(c);document.cookie=a+"="+encodeURIComponent(b)+(c?";expires="+h.toGMTString():"")+(e?";path="+e:"")+(g?";domain="+g:"")+(d?";secure":"")};d.prototype.__getCookie=function(a){for(var b=document.cookie.split(";"),c="",e="",d="",i=0,h=b.length;i<h;++i)if(c=b[i].split("="),e=c[0].replace(/^\s+|\s+$/g,""),
e===a)return c.length>1&&(d=decodeURIComponent(c[1].replace(/^\s+|\s+$/g,""))),d;return null};d.prototype.__storeInCookies=function(){this.__setCookie("shiterator",[this.__expires].concat(this.__storage).join("/"),this.__expires)};d.prototype.has=function(a){return this.__storage.indexOf(a)!==-1};d.prototype.put=function(a){this.__storage.push(a);this.__storeInCookies()};var m=function(a,b){this.__handler=this.__createErrorHandler(a,b);this.__IS_SAFARI?this.__useErrorToString():this.__useWindowOnError()};
m.prototype.__IS_SAFARI=navigator.userAgent.indexOf("Safari")!==-1;m.prototype.__useWindowOnError=function(){this.__previousErrorHandler=window.onerror;window.onerror=this.__handler};m.prototype.__useErrorToString=function(){var a=this;Error.prototype.toString=function(){a.__handler(this.message,this.sourceURL,this.line);return this.message}};m.prototype.__createErrorHandler=function(a,b){if(typeof a==="function"){var c=this,b=b||window;return function(){c.__previousErrorHandler&&c.__previousErrorHandler.apply(b,
arguments);return a.apply(b,arguments)}}};d=function(a){if(this.constructor._Singleton)return this;else this.constructor._Singleton=this;this.__retrieveFromCookies(a)};d.prototype.__retrieveFromCookies=function(a){this.__storage=[];var b=this.__getCookie("shiterator");if(b)this.__storage=b.split("/");(b=this.__storage.shift())||(b=new Date((new Date).getTime()+a*864E5));this.__expires=this.__expires=b};d.prototype.__setCookie=function(a,b,c,e,d,i){var h=new Date;h.setTime(h.getTime());h=new Date(c);
document.cookie=a+"="+encodeURIComponent(b)+(c?";expires="+h.toGMTString():"")+(e?";path="+e:"")+(d?";domain="+d:"")+(i?";secure":"")};d.prototype.__getCookie=function(a){for(var b=document.cookie.split(";"),c="",e="",d="",i=0,h=b.length;i<h;++i)if(c=b[i].split("="),e=c[0].replace(/^\s+|\s+$/g,""),e===a)return c.length>1&&(d=decodeURIComponent(c[1].replace(/^\s+|\s+$/g,""))),d;return null};d.prototype.__storeInCookies=function(){this.__setCookie("shiterator",[this.__expires].concat(this.__storage).join("/"),
this.__expires)};d.prototype.has=function(a){return this.__storage.indexOf(a)!==-1};d.prototype.put=function(a){this.__storage.push(a);this.__storeInCookies()};if(typeof Date.prototype.toJSON!=="function")Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+l(this.getUTCMonth()+1)+"-"+l(this.getUTCDate())+"T"+l(this.getUTCHours())+":"+l(this.getUTCMinutes())+":"+l(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=
function(){return this.valueOf()};var q=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,j,o,r={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k})();
